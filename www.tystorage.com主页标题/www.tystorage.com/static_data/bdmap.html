<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>公司地图导航</title>
<style>
html,body{height:100%;}
body{margin:0; padding:0;}
.BMap_bubble_title {
		font-size: 14px;
}

.BMap_bubble_content, .BMap_bubble_max_content {
		font-size: 12px;
}
</style>
</head>

<body>

<div id="allmap" style="height: 100%; width: 100%;"></div>

<script src="jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="bdmap_key.js"></script>
<script type="text/javascript">
    var map;
    var lastPoint;
	
	//获取url参数
	function getUrlParam(name) {
		var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
		var r = window.location.search.substr(1).match(reg);  //匹配目标参数
		if (r != null) {
			return unescape(r[2]); 
		}
		return ''; //返回参数值
	}
	//加载地图数据
	function loadMapData(){
		var var_id = getUrlParam('id');
		var url = 'bdmap_'+var_id+'.txt?v='+new Date().getTime();
		$.get(url,function(res){
			//console.log(res);
			init(res);
		},'json');
	}
	
    function init(data){
       //百度地图API功能
	   var map_point = data.map_point;
		var point = new BMap.Point(map_point.lng, map_point.lat);
		var content = TransferString(data.content);
	    map = new BMap.Map("allmap");    // 创建Map实例
        map.centerAndZoom(point, 18);  // 初始化地图,设置中心点坐标和地图级别
        map.setMapStyle({ style: 'normal' });
        map.addControl(new BMap.NavigationControl());   //添加地图类型控件
        map.addControl(new BMap.MapTypeControl());   //添加地图类型控件
	    map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
		addMarker(point, data.title, content);	//添加标注
    }
    // 编写自定义函数,创建标注
    function addMarker(point, itemTitle, itemDetail) {
        var marker = new BMap.Marker(point);
        map.addOverlay(marker);
        lastPoint = point;
        map.panTo(point);

        var opts = {
            width: 275,     // 信息窗口宽度
            title: itemTitle // 信息窗口标题
        }
        var infoWindow = new BMap.InfoWindow(itemDetail, opts);  // 创建信息窗口对象
        marker.addEventListener("click", function () {
            map.openInfoWindow(infoWindow, point); //开启信息窗口
        });
		map.openInfoWindow(infoWindow, point); //开启信息窗口
    }
	//替换回车符
	function TransferString(content){
		var string = content;
		try{
			string=string.replace(/\r\n/g,"<br />")
			string=string.replace(/\n/g,"<br />");
		}catch(e) {
			return content;
		}
		return string;
	}
	//加载百度地图JS库
	function loadBDMapLib(){
		var mode = getUrlParam('mode');
		var ak = mode==6?bdmap_key_user:bdmap_key_def;
		$.getScript('//api.map.baidu.com/api?v=3.0&ak=' + ak + '&callback=loadMapData');
	}
	
	loadBDMapLib();
</script>
</body>
</html>
